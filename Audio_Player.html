<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Player</title>
    <style>
        :root {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --accent-color: #4d9fff;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --waveform-color: #4d9fff;
            --neon-color: #4d9fff;
            --neon-glow: 0 0 10px #4d9fff, 0 0 20px #4d9fff, 0 0 30px #4d9fff, 0 0 40px #4d9fff;
            --border-color: #334155;

            /* === Neumorphic Variables (Dark Theme) === */
            --neumorph-bg-top: #2a2a2a;
            --neumorph-bg-bottom: #1a1a1a;
            --neumorph-shadow-light: inset 1px 1px 2px rgba(255, 255, 255, 0.1);
            --neumorph-shadow-main: 0 4px 6px rgba(0, 0, 0, 0.3);
            /* ======================================================= */
        }

        /* Light theme variables */
        .theme-light {
            --bg-primary: #f8fafc;
            --bg-secondary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --accent-color: #3b82f6;
            --waveform-color: #3b82f6;
            --neon-color: #3b82f6;
            --border-color: #cbd5e1;

            /* === Neumorphic Variables (Light Theme) === */
            --neumorph-bg-top: #ffffff;
            --neumorph-bg-bottom: #e6e6e6;
            --neumorph-shadow-light: inset 1px 1px 0 rgba(255, 255, 255, 0.7);
            --neumorph-shadow-main: 0 4px 6px rgba(0, 0, 0, 0.1);
            /* ======================================================= */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-y: auto;
            user-select: none;
            -webkit-user-select: none;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 480px;
            margin: 0 auto;
            width: 100%;
            padding: 20px;
            position: relative;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .lang-toggle-container {
            height: 40px;
            display: flex;
            align-items: center;
        }

        .lang-toggle-btn {
            width: 50px;
            height: 40px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            font-weight: 600;
            background: linear-gradient(to bottom, var(--neumorph-bg-top), var(--neumorph-bg-bottom));
            box-shadow:
                var(--neumorph-shadow-main),
                var(--neumorph-shadow-light),
                0 0 5px var(--neon-color);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        button {
            outline: none;
            -webkit-tap-highlight-color: transparent;
            cursor: pointer;
        }

        /* Style for disabled buttons */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none !important;
            transform: none !important;
            filter: none !important;
        }

        /* === MERGED BUTTON STYLES (Neumorphic + Neon) === */
        .header-btn,
        .control-btn,
        .skip-btn,
        .speed-btn,
        .chapter-btn,
        .file-btn,
        .modal-btn,
        .close-btn {
            background: linear-gradient(to bottom, var(--neumorph-bg-top), var(--neumorph-bg-bottom));
            box-shadow:
                var(--neumorph-shadow-main),
                var(--neumorph-shadow-light),
                0 0 5px var(--neon-color);
            /* Subtle base neon glow */
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .header-btn:active:not(:disabled),
        .control-btn:active:not(:disabled),
        .skip-btn:active:not(:disabled),
        .speed-btn:active:not(:disabled),
        .chapter-btn:active:not(:disabled),
        .file-btn:active:not(:disabled),
        .modal-btn:active,
        .close-btn:active {
            transform: translateY(1px);
            /* Slight press down */
            box-shadow:
                inset 2px 2px 5px rgba(0, 0, 0, 0.5),
                /* Pressed-in shadow */
                inset 0 0 15px var(--neon-color),
                /* Internal neon flash */
                0 0 5px var(--neon-color);
            /* Subtle outer glow remains */
        }

        /* ======================================================== */

        .header-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .album-art-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
            height: 80px;
        }

        .track-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .track-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .track-artist {
            font-size: 16px;
            color: var(--text-secondary);
        }

        .waveform-container {
            margin-bottom: 20px;
            position: relative;
            height: 60px;
        }

        .waveform {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .waveform-bar {
            width: 3px;
            background-color: var(--waveform-color);
            opacity: 0.4;
            border-radius: 3px;
            transition: opacity 0.2s, box-shadow 0.2s;
        }

        .waveform-bar.active {
            opacity: 1;
            box-shadow: 0 0 5px var(--neon-color);
        }

        .progress-container {
            width: 100%;
            height: 4px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-bottom: 10px;
            position: relative;
            cursor: pointer;
            touch-action: pan-y;
            box-shadow: 0 0 5px rgba(77, 159, 255, 0.3);
        }

        .progress-container.disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--accent-color);
            border-radius: 2px;
            width: 50%;
            position: relative;
            pointer-events: none;
            box-shadow: 0 0 5px var(--neon-color);
        }

        .progress-handle {
            width: 12px;
            height: 12px;
            background-color: white;
            border-radius: 50%;
            position: absolute;
            right: -6px;
            top: -4px;
            box-shadow: 0 0 10px white, 0 0 20px var(--neon-color);
            pointer-events: none;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .controls-primary,
        .controls-secondary {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .control-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .control-btn.small {
            width: 40px;
            height: 40px;
        }

        .control-btn.medium {
            width: 50px;
            height: 50px;
        }

        .play-pause-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 1px solid var(--accent-color);
            /* Special gradient for the main button */
            background: linear-gradient(to bottom, color-mix(in srgb, var(--accent-color) 85%, white), color-mix(in srgb, var(--accent-color) 85%, black));
            box-shadow:
                0 6px 10px rgba(0, 0, 0, 0.4),
                inset 1px 1px 2px rgba(255, 255, 255, 0.2),
                0 0 15px var(--neon-color), 0 0 30px var(--neon-color);
            transition: box-shadow 0.3s, transform 0.2s;
        }

        .play-pause-btn:active:not(:disabled) {
            transform: translateY(1px);
            box-shadow:
                inset 2px 2px 5px rgba(0, 0, 0, 0.5),
                inset 0 0 20px var(--neon-color),
                0 0 10px var(--neon-color);
        }

        .play-pause-btn svg {
            width: 25px;
            height: 25px;
            filter: drop-shadow(0 0 3px rgba(255, 255, 255, 0.7));
        }

        .skip-btn,
        .speed-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 5px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            font-size: 14px;
            color: var(--text-primary);
        }

        .skip-btn svg {
            width: 40px;
            height: 20px;
        }

        .skip-btn span {
            font-size: 12px;
            margin-top: 2px;
        }

        .speed-btn {
            justify-content: center;
            align-items: center;
            width: 50px;
            height: 50px;
            padding: 0;
            border-radius: 50%;
            font-size: 14px;
            color: var(--text-primary);
        }

        .chapter-btn {
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chapter-btn svg {
            width: 20px;
            height: 20px;
        }

        .file-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            margin-bottom: 30px;
        }

        .file-btn {
            padding: 10px 15px;
            border-radius: 25px;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 0 20px var(--neon-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-header .logo {
            height: 30px;
        }

        .modal-separator {
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(255, 255, 255, 0), var(--text-secondary), rgba(255, 255, 255, 0));
            margin: 20px 0;
        }

        .copyright-text {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 10px;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
        }

        .modal-body {
            margin-bottom: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-body p {
            margin-bottom: 10px;
        }

        .modal-body p:last-child {
            margin-bottom: 0;
        }

        .speed-slider-container {
            margin: 20px 0;
        }

        .speed-slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: var(--bg-primary);
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            box-shadow: 0 0 10px var(--neon-color);
            transition: box-shadow 0.2s;
        }

        .speed-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px var(--neon-color);
            transition: box-shadow 0.2s;
        }

        .speed-slider:active::-webkit-slider-thumb,
        .speed-slider:active::-moz-range-thumb {
            box-shadow: 0 0 15px var(--neon-color), 0 0 25px var(--neon-color);
        }

        .speed-value-display {
            text-align: center;
            font-size: 32px;
            font-weight: 600;
            margin-top: 15px;
            color: var(--accent-color);
        }

        .modal-footer {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 14px;
        }

        .modal-btn.apply {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }

        /* Sidebar styles */
        .sidebar {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100%;
            background-color: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.3);
            transition: right 0.3s ease;
            z-index: 999;
            overflow-y: auto;
            padding: 20px;
        }

        .sidebar.open {
            right: 0;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 600;
        }

        .chapter-list {
            list-style: none;
        }

        .chapter-item {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            border-left: 3px solid transparent;
        }

        .chapter-item.active {
            background-color: rgba(77, 159, 255, 0.3);
            font-weight: 600;
            border-left: 3px solid var(--accent-color);
        }

        .chapter-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .chapter-item:active {
            box-shadow: 0 0 15px var(--neon-color), 0 0 25px var(--neon-color);
        }

        /* RTL styles for Arabic */
        .rtl-modal {
            direction: rtl;
            text-align: right;
        }

        .rtl-modal .modal-header {
            flex-direction: row-reverse;
        }

        .rtl-modal .modal-footer {
            flex-direction: row-reverse;
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .app-container {
                padding: 15px;
            }

            .album-art-container {
                height: 60px;
            }

            .control-btn.small {
                width: 35px;
                height: 35px;
            }

            .control-btn.medium {
                width: 45px;
                height: 45px;
            }

            .play-pause-btn {
                width: 50px;
                height: 50px;
            }

            .file-btn {
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        @media (max-height: 700px) {
            .album-art-container {
                height: 40px;
            }

            .waveform-container {
                height: 50px;
                margin-bottom: 15px;
            }
        }

        /* Hover effects are now only applied on devices that support hover */
        @media (hover: hover) {

            .header-btn:hover:not(:disabled),
            .control-btn:hover:not(:disabled),
            .skip-btn:hover:not(:disabled),
            .speed-btn:hover:not(:disabled),
            .chapter-btn:hover:not(:disabled),
            .file-btn:hover:not(:disabled),
            .modal-btn:hover,
            .lang-toggle-btn:hover {
                transform: translateY(-2px);
                box-shadow:
                    0 6px 10px rgba(0, 0, 0, 0.4),
                    /* Deeper main shadow */
                    inset 1px 1px 2px rgba(255, 255, 255, 0.2),
                    /* Stronger highlight */
                    0 0 10px var(--neon-color), 0 0 20px var(--neon-color);
                /* Stronger neon glow */
            }

            .modal-btn.apply:hover {
                background-color: var(--accent-color);
                border-color: var(--accent-color);
            }

            .play-pause-btn:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow:
                    0 8px 15px rgba(0, 0, 0, 0.5),
                    inset 1px 1px 3px rgba(255, 255, 255, 0.3),
                    0 0 20px var(--neon-color), 0 0 40px var(--neon-color);
            }

            .chapter-item:hover {
                background-color: rgba(77, 159, 255, 0.2);
            }

            .speed-slider::-webkit-slider-thumb:hover {
                box-shadow: 0 0 15px var(--neon-color), 0 0 25px var(--neon-color);
            }

            .speed-slider::-moz-range-thumb:hover {
                box-shadow: 0 0 15px var(--neon-color), 0 0 25px var(--neon-color);
            }
        }

        button:focus-visible {
            box-shadow: 0 0 10px var(--neon-color), 0 0 20px var(--neon-color);
        }

        /* Toast Notification Styles */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: 50px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3), 0 0 15px var(--neon-color);
            z-index: 10000;
            /* فوق كل شيء */
            opacity: 0;
            /* مخفي في البداية */
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            font-size: 14px;
            text-align: center;
            pointer-events: none;
            /* يسمح بالنقر من خلاله */
            min-width: 300px;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-10px);
        }

        .toast.rtl {
            direction: rtl;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <div class="header">
            <div class="lang-toggle-container">
                <button class="lang-toggle-btn" id="lang-toggle" title="Toggle Language">
                    AR
                </button>
            </div>

            <div class="header-buttons">
                <button class="header-btn" id="theme-toggle" title="Toggle theme">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g id="sun-icon" fill="currentColor">
                            <circle cx="12" cy="12" r="5" />
                            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </g>
                        <path id="moon-icon" d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="currentColor" opacity="0" />
                    </svg>
                </button>
                <button class="header-btn" id="help-btn" title="Help">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12,2C6.48,2 2,6.48 2,12s4.48,10 10,10s10-4.48 10-10S17.52,2 12,2z M13,19h-2v-2h2V19z M15.07,11.25l-0.9,0.92 C13.45,12.9 13,13.5 13,15h-2v-0.5c0-1.1,0.45-2.1,1.17-2.83l1.24-1.26c0.37-0.36,0.59-0.86,0.59-1.41 c0-1.1-0.9-2-2-2s-2,0.9-2,2H8c0-2.21,1.79-4 4-4s4,1.79 4,4C16,10.13,15.63,10.88,15.07,11.25z" fill="currentColor" />
                    </svg>
                </button>
                <button class="header-btn" id="about-btn" title="About">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12,2C6.48,2 2,6.48 2,12s4.48,10 10,10s10-4.48 10-10S17.52,2 12,2z M13,17h-2v-6h2V17z M13,9h-2V7h2V9z" fill="currentColor" />
                    </svg>
                </button>
                <button class="header-btn" id="chapters-menu-btn" title="Chapters" disabled>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3,13H5V11H3V13M3,17H5V15H3V17M3,9H5V7H3V9M7,13H21V11H7V13M7,17H21V15H7V17M7,7V9H21V7H7Z" fill="currentColor" />
                    </svg>
                </button>
            </div>
        </div>

        <div class="album-art-container">
        </div>

        <div class="track-info">
            <div class="track-title" id="track-title">No track loaded</div>
            <div class="track-artist" id="track-artist" style="display: none;"></div>
        </div>

        <div class="waveform-container">
            <div class="waveform" id="waveform"></div>
        </div>

        <div class="progress-container disabled" id="progress-container">
            <div class="progress-bar" id="progress-bar">
                <div class="progress-handle"></div>
            </div>
        </div>

        <div class="time-display">
            <span id="current-time">0:00</span>
            <span id="total-time">0:00</span>
        </div>

        <div class="controls">
            <div class="controls-primary">
                <button class="control-btn chapter-btn" id="prev-chapter-btn" title="Previous Chapter" disabled>
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4,18L13,12L4,6V18M13,6V18L22,12L13,6Z" transform="scale(-1, 1) translate(-24, 0) rotate(0)" fill="currentColor" />
                    </svg>
                </button>

                <button class="control-btn play-pause-btn" id="play-pause-btn" title="Play/Pause" disabled>
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" id="play-icon">
                        <path d="M8 5v14l11-7z" fill="white" />
                    </svg>
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" id="pause-icon" style="display: none;">
                        <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" fill="white" />
                    </svg>
                </button>

                <button class="control-btn chapter-btn" id="next-chapter-btn" title="Next Chapter" disabled>
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4,18L13,12L4,6V18M13,6V18L22,12L13,6Z" fill="currentColor" />
                    </svg>
                </button>
            </div>

            <div class="controls-secondary">
                <button class="control-btn skip-btn" id="backward-btn" title="Backward 10s" disabled>
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11.5,8C8.85,8 6.45,9 4.6,10.6L1,7V16H10L6.38,12.38C7.77,11.22 9.54,10.5 11.5,10.5C15.04,10.5 18.05,12.81 19.1,16L21.47,15.22C20.08,11.03 16.15,8 11.5,8Z" fill="currentColor" />
                    </svg>
                    <span>-10s</span>
                </button>

                <button class="control-btn speed-btn" id="speed-btn" title="Playback Speed" disabled>
                    <span>1.0x</span>
                </button>

                <button class="control-btn skip-btn" id="forward-btn" title="Forward 10s" disabled>
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11.5,8C9.85,8 7.45,9 5.6,10.6L2,7V16H11L7.38,12.38C8.77,11.22 10.54,10.5 12.5,10.5C16.04,10.5 19.05,12.81 20.1,16L22.47,15.22C21.08,11.03 17.15,8 12.5,8Z" transform="scale(-1, 1) translate(-24, 0)" fill="currentColor" />
                    </svg>
                    <span>+10s</span>
                </button>
            </div>
        </div>

        <div class="file-buttons">
            <button class="file-btn" id="load-audio-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z" fill="currentColor" />
                </svg>
                <span id="load-audio-text">Load Audio</span>
            </button>
            <button class="file-btn" id="load-chapters-btn" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" fill="currentColor" />
                </svg>
                <span id="load-chapters-text">Load Chapters</span>
            </button>
        </div>
    </div>

    <input type="file" id="audio-file-input" accept=".mp3, .wav, .ogg, .m4a, .flac, audio/*" style="display: none;">
    <input type="file" id="chapters-file-input" accept=".txt,.csv" style="display: none;">

    <div class="modal" id="help-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="help-modal-title">How to Use</h3>
                <button class="close-btn" id="close-help-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="help-loading-audio"><strong>Loading Audio:</strong></p>
                <p id="help-loading-audio-desc">Click "Load Audio" button to select an audio file from your device.</p>
                <br>
                <p id="help-loading-chapters"><strong>Loading Chapters:</strong></p>
                <p id="help-loading-chapters-desc">You can load chapters from a CSV or TXT file. The file should contain timestamps and chapter titles.</p>
                <br>
                <p id="help-csv-format"><strong>CSV Format:</strong></p>
                <pre id="help-csv-example">00:00:00,Introduction
00:02:30,Chapter 1
01:15:20,Conclusion</pre>
                <br>
                <p id="help-txt-format"><strong>TXT Format:</strong></p>
                <pre id="help-txt-example">00:00:00 Introduction
00:02:30 Chapter 1
01:15:20 Conclusion</pre>
            </div>
            <div class="modal-footer">
                <button class="modal-btn apply" id="close-help-btn">Got it!</button>
            </div>
        </div>
    </div>

    <div class="modal" id="about-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="about-modal-title">About</h3>
                <button class="close-btn" id="close-about-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="about-version"><strong>Audio Player - version 1.0.3</strong></p>
                <p id="about-description">Carefully developed to provide a smooth and enjoyable listening experience.</p>
                <br>
                <p id="about-developer"><strong>Developer:</strong> Laith</p>
                <p id="about-contact"><strong>Contact:</strong> moallam940@gmail.com</p>
                <hr class="modal-separator">
                <p class="copyright-text" id="about-copyright">© 2025 Laith. All rights reserved.</p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn apply" id="close-about-btn">Got it!</button>
            </div>
        </div>
    </div>

    <div class="modal" id="speed-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="speed-modal-title">Playback Speed</h3>
                <button class="close-btn" id="close-speed-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="speed-slider-container">
                    <input type="range" min="0.5" max="2" step="0.1" value="1" class="speed-slider" id="speed-slider">
                    <div class="speed-value-display" id="speed-value-display">1.0x</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" id="reset-speed-btn">Reset</button>
                <button class="modal-btn apply" id="apply-speed-btn">Apply</button>
            </div>
        </div>
    </div>

    <div class="sidebar" id="chapters-sidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title" id="chapters-title">Chapters</h3>
            <button class="close-btn" id="close-sidebar">&times;</button>
        </div>
        <ul class="chapter-list" id="chapter-list">
            <li class="chapter-item" id="no-chapters-text">No chapters loaded</li>
        </ul>
    </div>

    <script>
        // Generate waveform bars
        const waveformContainer = document.getElementById('waveform');
        const barCount = 50;

        for (let i = 0; i < barCount; i++) {
            const bar = document.createElement('div');
            bar.classList.add('waveform-bar');
            const height = Math.random() * 70 + 10;
            bar.style.height = `${height}%`;
            waveformContainer.appendChild(bar);
        }

        // DOM Elements
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        const progressBar = document.getElementById('progress-bar');
        const currentTimeEl = document.getElementById('current-time');
        const totalTimeEl = document.getElementById('total-time');
        const trackTitleEl = document.getElementById('track-title');
        const trackArtistEl = document.getElementById('track-artist');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const helpBtn = document.getElementById('help-btn');
        const helpModal = document.getElementById('help-modal');
        const closeHelpModal = document.getElementById('close-help-modal');
        const closeHelpBtn = document.getElementById('close-help-btn');
        // About modal elements
        const aboutBtn = document.getElementById('about-btn');
        const aboutModal = document.getElementById('about-modal');
        const closeAboutModal = document.getElementById('close-about-modal');
        const closeAboutBtn = document.getElementById('close-about-btn');
        const loadAudioBtn = document.getElementById('load-audio-btn');
        const loadChaptersBtn = document.getElementById('load-chapters-btn');
        const audioFileInput = document.getElementById('audio-file-input');
        const chaptersFileInput = document.getElementById('chapters-file-input');
        const prevChapterBtn = document.getElementById('prev-chapter-btn');
        const nextChapterBtn = document.getElementById('next-chapter-btn');
        const chaptersSidebar = document.getElementById('chapters-sidebar');
        const closeSidebar = document.getElementById('close-sidebar');
        const chapterList = document.getElementById('chapter-list');
        const chaptersMenuBtn = document.getElementById('chapters-menu-btn');
        const progressContainer = document.getElementById('progress-container');
        const appVersionEl = document.getElementById('app-version');

        const speedBtn = document.getElementById('speed-btn');
        const speedModal = document.getElementById('speed-modal');
        const closeSpeedModal = document.getElementById('close-speed-modal');
        const speedSlider = document.getElementById('speed-slider');
        const speedValueDisplay = document.getElementById('speed-value-display');
        const resetSpeedBtn = document.getElementById('reset-speed-btn');
        const applySpeedBtn = document.getElementById('apply-speed-btn');

        // Language toggle elements
        const langToggleBtn = document.getElementById('lang-toggle');

        // State variables
        let isPlaying = false;
        let audio = null;
        let chapters = [];
        let currentChapterIndex = -1;
        let isDragging = false;
        let wakeLock = null;
        let currentPlaybackRate = 1.0;
        let currentLanguage = localStorage.getItem('language') || 'ar'; // Default language is English

        // Language translations
        const translations = {
            en: {
                langToggle: 'AR',
                noTrackLoaded: 'No track loaded',
                loadAudio: 'Load Audio',
                loadChapters: 'Load Chapters',
                invalidFileType: 'Invalid File Type',
                invalidFileTypeDesc: 'Please select a .txt or .csv file for chapters.',
                invalidAudioFileType: 'Invalid Audio File',
                invalidAudioFileTypeDesc: 'Please select a valid audio file (e.g., .mp3, .wav)',
                helpTitle: 'How to Use',
                helpLoadingAudio: 'Loading Audio:',
                helpLoadingAudioDesc: 'Click "Load Audio" button to select an audio file from your device.',
                helpLoadingChapters: 'Loading Chapters:',
                helpLoadingChaptersDesc: 'You can load chapters from a CSV or TXT file. The file should contain timestamps and chapter titles.',
                helpCsvFormat: 'CSV Format:',
                helpTxtFormat: 'TXT Format:',
                csvExample: "00:00:00,Introduction\n00:02:30,Chapter 1\n01:15:20,Conclusion",
                txtExample: "00:00:00 Introduction\n00:02:30 Chapter 1\n01:15:20 Conclusion",
                gotIt: 'Got it!',
                aboutTitle: 'About',
                aboutVersion: 'Audio Player - version 1.0.3',
                aboutDescription: 'Carefully developed to provide a smooth and enjoyable listening experience.',
                aboutDeveloper: 'Developer:',
                aboutDeveloperName: 'Laith',
                aboutContact: 'Contact:',
                aboutCopyright: '© 2025 Laith. All rights reserved.',
                speedTitle: 'Playback Speed',
                reset: 'Reset',
                apply: 'Apply',
                chaptersTitle: 'Chapters',
                noChaptersLoaded: 'No chapters loaded',
                backward10s: '-10s',
                forward10s: '+10s',
                previousChapter: 'Previous Chapter',
                nextChapter: 'Next Chapter',
                playPause: 'Play/Pause',
                playbackSpeed: 'Playback Speed',
                chapters: 'Chapters',
                help: 'Help',
                about: 'About',
                toggleTheme: 'Toggle theme'
            },
            ar: {
                langToggle: 'EN',
                noTrackLoaded: 'لم يتم تحميل أي مقطع صوتي',
                loadAudio: 'تحميل صوت',
                loadChapters: 'تحميل الفصول',
                invalidFileType: 'نوع ملف غير صالح',
                invalidFileTypeDesc: 'يرجى اختيار ملف .txt أو .csv للفصول.',
                invalidAudioFileType: 'ملف صوتي غير صالح',
                invalidAudioFileTypeDesc: ' يرجى اختيار ملف صوتي صالح (مثل .mp3, .wav)',
                helpTitle: 'كيفية الاستخدام',
                helpLoadingAudio: 'تحميل الصوت:',
                helpLoadingAudioDesc: 'انقر على زر "تحميل صوت" لاختيار ملف صوتي من جهازك.',
                helpLoadingChapters: 'تحميل الفصول:',
                helpLoadingChaptersDesc: 'يمكنك تحميل الفصول من ملف CSV أو TXT. يجب أن يحتوي الملف على الطوابع الزمنية وعناوين الفصول.',
                helpCsvFormat: 'تنسيق CSV:',
                helpTxtFormat: 'تنسيق TXT:',
                csvExample: "مقدمة,00:00:00\nالفصل الأول,00:02:30\nخاتمة,01:15:20",
                txtExample: "مقدمة 00:00:00\nالفصل الأول 00:02:30\nخاتمة 01:15:20",
                gotIt: 'فهمت!',
                aboutTitle: 'حول',
                aboutVersion: 'مشغل الصوت - الإصدار 1.0.3',
                aboutDescription: 'تم تطويره بعناية لتوفير تجربة استماع سلسة وممتعة.',
                aboutDeveloper: 'المطور:',
                aboutDeveloperName: 'ليث',
                aboutContact: 'التواصل:',
                aboutCopyright: '© 2025 ليث. جميع الحقوق محفوظة.',
                speedTitle: 'سرعة التشغيل',
                reset: 'إعادة تعيين',
                apply: 'تطبيق',
                chaptersTitle: 'الفصول',
                noChaptersLoaded: 'لم يتم تحميل أي فصول',
                backward10s: '-10 ثانية',
                forward10s: '+10 ثانية',
                previousChapter: 'الفصل السابق',
                nextChapter: 'الفصل التالي',
                playPause: 'تشغيل/إيقاف',
                playbackSpeed: 'سرعة التشغيل',
                chapters: 'الفصول',
                help: 'مساعدة',
                about: 'حول',
                toggleTheme: 'تبديل المظهر'
            }
        };

        // Helper function to enable/disable buttons
        function setButtonState(buttonId, isEnabled) {
            const button = document.getElementById(buttonId);
            if (isEnabled) {
                button.disabled = false;
            } else {
                button.disabled = true;
            }
        }

        // Initialize theme
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'light') {
                document.body.classList.add('theme-light');
                updateThemeIcon(true);
            } else {
                document.body.classList.remove('theme-light');
                updateThemeIcon(false);
            }
        }

        // Update theme icon
        function updateThemeIcon(isLight) {
            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');

            if (isLight) {
                sunIcon.style.opacity = '0';
                moonIcon.style.opacity = '1';
            } else {
                sunIcon.style.opacity = '1';
                moonIcon.style.opacity = '0';
            }
        }

        // Format time in MM:SS or HH:MM:SS
        function formatTime(seconds) {
            seconds = Math.floor(seconds);
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;

            if (h > 0) {
                return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            } else {
                return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }
        }

        // Parse time string to seconds
        function parseTimeString(timeStr) {
            timeStr = timeStr.trim();
            if (!timeStr) return 0;

            const parts = timeStr.split(':').map(Number);
            if (parts.length === 1) return parts[0] || 0;
            if (parts.length === 2) return (parts[0] || 0) * 60 + (parts[1] || 0);
            if (parts.length === 3) return (parts[0] || 0) * 3600 + (parts[1] || 0) * 60 + (parts[2] || 0);

            return 0;
        }

        // Parse chapters from text
        function parseChapters(text) {
            try {
                console.log("Parsing chapters from text:", text.substring(0, 100) + "..."); // DEBUG
                chapters = [];
                const lines = text.trim().split('\n');

                for (let line of lines) {
                    line = line.trim();
                    if (!line || line.startsWith('#')) continue;

                    let separator = line.includes(';') ? ';' : (line.includes(',') ? ',' : null);

                    if (separator) {
                        const parts = line.split(separator).map(p => p.trim());
                        if (parts.length >= 2) {
                            const time = parseTimeString(parts[0]);
                            const title = parts.slice(1).join(' ');
                            if (!isNaN(time)) chapters.push({
                                time,
                                title
                            });
                        }
                    } else {
                        const firstSpace = line.indexOf(' ');
                        if (firstSpace > 0) {
                            const timePart = line.substring(0, firstSpace);
                            const titlePart = line.substring(firstSpace + 1).trim();
                            if (titlePart) {
                                const time = parseTimeString(timePart);
                                if (!isNaN(time)) chapters.push({
                                    time,
                                    title: titlePart
                                });
                            }
                        }
                    }
                }

                chapters.sort((a, b) => a.time - b.time);
                renderChapters();
                console.log("Successfully parsed and rendered", chapters.length, "chapters."); // DEBUG
            } catch (error) {
                console.error("An unexpected error occurred during chapter parsing:", error); // DEBUG
                chapters = []; // Reset to empty on error
                renderChapters(); // Update UI to show no chapters
            }
        }

        // Render chapters in sidebar
        function renderChapters() {
            if (chapters.length === 0) {
                chapterList.innerHTML = `<li class="chapter-item" id="no-chapters-text">${translations[currentLanguage].noChaptersLoaded}</li>`;
                setButtonState('chapters-menu-btn', false);
                setButtonState('prev-chapter-btn', false);
                setButtonState('next-chapter-btn', false);
                return;
            }

            chapterList.innerHTML = '';
            chapters.forEach((chapter, index) => {
                const li = document.createElement('li');
                li.className = 'chapter-item';
                li.innerHTML = `
                    <div>${chapter.title}</div>
                    <div class="chapter-time">${formatTime(chapter.time)}</div>
                `;

                li.addEventListener('click', () => {
                    if (audio) {
                        audio.currentTime = chapter.time;
                        updateCurrentChapter();
                    }
                });

                chapterList.appendChild(li);
            });

            setButtonState('chapters-menu-btn', true);
            setButtonState('prev-chapter-btn', true);
            setButtonState('next-chapter-btn', true);
        }

        // Update current chapter
        function updateCurrentChapter() {
            if (!audio || chapters.length === 0) return;

            const currentTime = audio.currentTime;
            let newChapterIndex = -1;

            for (let i = chapters.length - 1; i >= 0; i--) {
                if (currentTime >= chapters[i].time) {
                    newChapterIndex = i;
                    break;
                }
            }

            if (newChapterIndex !== currentChapterIndex) {
                currentChapterIndex = newChapterIndex;

                const chapterItems = document.querySelectorAll('.chapter-item');
                chapterItems.forEach((item, index) => {
                    if (index === currentChapterIndex) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });

                if (currentChapterIndex >= 0) {
                    trackTitleEl.textContent = chapters[currentChapterIndex].title;
                }
            }
        }

        // Request wake lock
        async function requestWakeLock() {
            // ملاحظة: واجهة برمجة تطبيقات Wake Lock تتطلب تفاعل المستخدم وأن تكون الصفحة مرئية.
            // قد يرفضها المتصفح، خاصة على الأجهزة المحمولة أو من عناوين file://.
            // هذا ليس خطأً فادحًا؛ سيستمر الصوت في التشغيل.
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log("Wake lock active."); // DEBUG
                } catch (err) {
                    console.error('Wake Lock error:', err);
                }
            }
        }

        // Release wake lock
        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release().then(() => {
                    wakeLock = null;
                }).catch(err => {
                    console.error('Wake Lock release error:', err);
                });
            }
        }

        // Update waveform based on progress
        function updateWaveform(progress) {
            const waveformBars = document.querySelectorAll('.waveform-bar');
            const activeBars = Math.floor(barCount * (progress / 100));

            waveformBars.forEach((bar, index) => {
                if (index < activeBars) {
                    bar.classList.add('active');
                } else {
                    bar.classList.remove('active');
                }
            });
        }

        // Update progress
        function updateProgress() {
            if (!audio) return;

            const progress = (audio.currentTime / audio.duration) * 100;
            progressBar.style.width = `${progress}%`;
            currentTimeEl.textContent = formatTime(audio.currentTime);
            updateWaveform(progress);
            updateCurrentChapter();
        }

        // Update UI text based on current language
        function updateLanguage() {
            const t = translations[currentLanguage];

            // Update button texts
            document.getElementById('lang-toggle').textContent = t.langToggle;
            document.getElementById('load-audio-text').textContent = t.loadAudio;
            document.getElementById('load-chapters-text').textContent = t.loadChapters;

            // Update modal titles
            document.getElementById('help-modal-title').textContent = t.helpTitle;
            document.getElementById('about-modal-title').textContent = t.aboutTitle;
            document.getElementById('speed-modal-title').textContent = t.speedTitle;
            document.getElementById('chapters-title').textContent = t.chaptersTitle;

            // Update modal content
            document.getElementById('help-loading-audio').innerHTML = `<strong>${t.helpLoadingAudio}</strong>`;
            document.getElementById('help-loading-audio-desc').textContent = t.helpLoadingAudioDesc;
            document.getElementById('help-loading-chapters').innerHTML = `<strong>${t.helpLoadingChapters}</strong>`;
            document.getElementById('help-loading-chapters-desc').textContent = t.helpLoadingChaptersDesc;
            document.getElementById('help-csv-format').innerHTML = `<strong>${t.helpCsvFormat}</strong>`;
            document.getElementById('help-txt-format').innerHTML = `<strong>${t.helpTxtFormat}</strong>`;

document.getElementById('help-csv-example').textContent = t.csvExample;
    document.getElementById('help-txt-example').textContent = t.txtExample;
            document.getElementById('close-help-btn').textContent = t.gotIt;
            document.getElementById('close-about-btn').textContent = t.gotIt;

            document.getElementById('about-version').innerHTML = `<strong>${t.aboutVersion}</strong>`;
            document.getElementById('about-description').textContent = t.aboutDescription;
            document.getElementById('about-developer').innerHTML = `<strong>${t.aboutDeveloper}</strong> ${t.aboutDeveloperName}`;
            document.getElementById('about-contact').innerHTML = `<strong>${t.aboutContact}</strong> moallam940@gmail.com`;
            document.getElementById('about-copyright').textContent = t.aboutCopyright;

            document.getElementById('reset-speed-btn').textContent = t.reset;
            document.getElementById('apply-speed-btn').textContent = t.apply;

            // Update other elements
            const noChaptersElement = document.getElementById('no-chapters-text');
            if (noChaptersElement) {
                noChaptersElement.textContent = t.noChaptersLoaded;
            }
            document.querySelector('#backward-btn span').textContent = t.backward10s;
            document.querySelector('#forward-btn span').textContent = t.forward10s;

            // Update tooltips
            document.getElementById('prev-chapter-btn').setAttribute('title', t.previousChapter);
            document.getElementById('next-chapter-btn').setAttribute('title', t.nextChapter);
            document.getElementById('play-pause-btn').setAttribute('title', t.playPause);
            document.getElementById('speed-btn').setAttribute('title', t.playbackSpeed);
            document.getElementById('chapters-menu-btn').setAttribute('title', t.chapters);
            document.getElementById('help-btn').setAttribute('title', t.help);
            document.getElementById('about-btn').setAttribute('title', t.about);
            document.getElementById('theme-toggle').setAttribute('title', t.toggleTheme);

            // Update track title if no track is loaded
            if (!audio) {
                trackTitleEl.textContent = t.noTrackLoaded;
            }

            // Update modal direction based on language
            if (currentLanguage === 'ar') {
                helpModal.classList.add('rtl-modal');
                aboutModal.classList.add('rtl-modal');
                speedModal.classList.add('rtl-modal');
            } else {
                helpModal.classList.remove('rtl-modal');
                aboutModal.classList.remove('rtl-modal');
                speedModal.classList.remove('rtl-modal');
            }

            // Re-render chapters if they exist
            if (chapters.length > 0) {
                renderChapters();
            }
        }

        // Toggle language
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'en' ? 'ar' : 'en';
            localStorage.setItem('language', currentLanguage);
            updateLanguage();
        }

        // Initialize language
        function initLanguage() {
            // Set initial language from localStorage or default to 'en'
            currentLanguage = localStorage.getItem('language') || 'en';
            updateLanguage();
        }

        // Theme toggle
        function toggleTheme() {
            document.body.classList.toggle('theme-light');
            const isLight = document.body.classList.contains('theme-light');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            updateThemeIcon(isLight);
        }

        // Play/Pause functionality
        function togglePlayPause() {
            if (!audio) return;

            if (isPlaying) {
                audio.pause();
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
                releaseWakeLock();
            } else {
                audio.play();
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
                requestWakeLock();
                audioFileInput.value = '';
            }

            isPlaying = !isPlaying;
        }

        // Load audio file
        function loadAudioFile(file) {
            if (!file) return;

            const fileURL = URL.createObjectURL(file);

            if (audio) {
                audio.pause();
                audio.src = '';
                URL.revokeObjectURL(audio.src);
            }

            // Clear chapters when loading a new audio file
            chapters = [];
            currentChapterIndex = -1;
            renderChapters();
            setButtonState('load-chapters-btn', false);

            audio = new Audio(fileURL);
            audio.addEventListener('loadedmetadata', () => {
                totalTimeEl.textContent = formatTime(audio.duration);
                progressContainer.classList.remove('disabled');
                setButtonState('play-pause-btn', true);
                setButtonState('backward-btn', true);
                setButtonState('forward-btn', true);
                setButtonState('speed-btn', true);
                setButtonState('load-chapters-btn', true);

                // Reset track info
                trackTitleEl.textContent = file.name.replace(/\.[^/.]+$/, "");
                trackArtistEl.style.display = 'none';

                // Reset progress
                progressBar.style.width = '0%';
                currentTimeEl.textContent = '0:00';

                // Reset waveform
                updateWaveform(0);

                // Auto-play when audio is loaded
                audio.play();
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
                isPlaying = true;
                requestWakeLock();
            });

            audio.addEventListener('timeupdate', updateProgress);

            audio.addEventListener('ended', () => {
                isPlaying = false;
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
                releaseWakeLock();
            });
        }

        // Load chapters file
        function loadChaptersFile(file) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                parseChapters(text);
                chaptersFileInput.value = '';
            };
            reader.readAsText(file);
        }

        // Event Listeners
        langToggleBtn.addEventListener('click', toggleLanguage);

        themeToggleBtn.addEventListener('click', toggleTheme);

        playPauseBtn.addEventListener('click', togglePlayPause);

        loadAudioBtn.addEventListener('click', () => {
            audioFileInput.click();
        });

        audioFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const fileName = file.name.toLowerCase();
                const validAudioTypes = ['.mp3', '.wav', '.ogg', '.m4a', '.flac'];
                const isValidType = validAudioTypes.some(type => fileName.endsWith(type));

                if (!isValidType) {
                    showToast(translations[currentLanguage].invalidAudioFileTypeDesc);
                    audioFileInput.value = '';
                    return;
                }
                loadAudioFile(file);
            }
        });

        loadChaptersBtn.addEventListener('click', () => {
            chaptersFileInput.click();
        });

        chaptersFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                // --- بداية الكود الجديد للتحقق من نوع الملف ---
                const fileName = file.name.toLowerCase();
                const isValidType = fileName.endsWith('.txt') || fileName.endsWith('.csv');

                if (!isValidType) {
                    showToast(translations[currentLanguage].invalidFileTypeDesc);
                    chaptersFileInput.value = ''; // إفراغ حقل الاختيار
                    return; // إيقاف تنفيذ باقي الكود
                }
                // --- نهاية الكود الجديد ---

                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    parseChapters(text);
                    chaptersFileInput.value = '';
                };
                reader.readAsText(file);
            }
        });

        // Progress bar click/drag functionality
        progressContainer.addEventListener('mousedown', (e) => {
            if (!audio || progressContainer.classList.contains('disabled')) return;
            isDragging = true;
            updateProgressFromMouse(e);
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                updateProgressFromMouse(e);
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });

        // Touch events for mobile
        progressContainer.addEventListener('touchstart', (e) => {
            if (!audio || progressContainer.classList.contains('disabled')) return;
            isDragging = true;
            updateProgressFromTouch(e);
        });

        document.addEventListener('touchmove', (e) => {
            if (isDragging) {
                updateProgressFromTouch(e);
            }
        });

        document.addEventListener('touchend', () => {
            isDragging = false;
        });

        function updateProgressFromMouse(e) {
            if (!audio) return;

            const rect = progressContainer.getBoundingClientRect();
            const pos = (e.clientX - rect.left) / rect.width;
            audio.currentTime = pos * audio.duration;
            updateProgress();
        }

        function updateProgressFromTouch(e) {
            if (!audio) return;

            const rect = progressContainer.getBoundingClientRect();
            const pos = (e.touches[0].clientX - rect.left) / rect.width;
            audio.currentTime = pos * audio.duration;
            updateProgress();
        }

        // Skip buttons
        document.getElementById('backward-btn').addEventListener('click', () => {
            if (audio) {
                audio.currentTime = Math.max(0, audio.currentTime - 10);
            }
        });

        document.getElementById('forward-btn').addEventListener('click', () => {
            if (audio) {
                audio.currentTime = Math.min(audio.duration, audio.currentTime + 10);
            }
        });

        // Chapter navigation
        document.getElementById('prev-chapter-btn').addEventListener('click', () => {
            if (!audio || chapters.length === 0) return;

            let prevChapterIndex = currentChapterIndex - 1;
            if (prevChapterIndex < 0) prevChapterIndex = 0;

            audio.currentTime = chapters[prevChapterIndex].time;
        });

        document.getElementById('next-chapter-btn').addEventListener('click', () => {
            if (!audio || chapters.length === 0) return;

            let nextChapterIndex = currentChapterIndex + 1;
            if (nextChapterIndex >= chapters.length) nextChapterIndex = chapters.length - 1;

            audio.currentTime = chapters[nextChapterIndex].time;
        });

        // Chapters sidebar
        chaptersMenuBtn.addEventListener('click', () => {
            chaptersSidebar.classList.add('open');
        });

        closeSidebar.addEventListener('click', () => {
            chaptersSidebar.classList.remove('open');
        });

        // Modal functionality
        helpBtn.addEventListener('click', () => {
            helpModal.style.display = 'flex';
        });

        closeHelpModal.addEventListener('click', () => {
            helpModal.style.display = 'none';
        });

        closeHelpBtn.addEventListener('click', () => {
            helpModal.style.display = 'none';
        });

        aboutBtn.addEventListener('click', () => {
            aboutModal.style.display = 'flex';
        });

        closeAboutModal.addEventListener('click', () => {
            aboutModal.style.display = 'none';
        });

        closeAboutBtn.addEventListener('click', () => {
            aboutModal.style.display = 'none';
        });

        // Speed modal
        speedBtn.addEventListener('click', () => {
            speedSlider.value = currentPlaybackRate;
            speedValueDisplay.textContent = currentPlaybackRate.toFixed(1) + 'x';
            speedModal.style.display = 'flex';
        });

        closeSpeedModal.addEventListener('click', () => {
            speedModal.style.display = 'none';
        });

        speedSlider.addEventListener('input', () => {
            speedValueDisplay.textContent = parseFloat(speedSlider.value).toFixed(1) + 'x';
        });

        resetSpeedBtn.addEventListener('click', () => {
            speedSlider.value = 1.0;
            speedValueDisplay.textContent = '1.0x';
        });

        applySpeedBtn.addEventListener('click', () => {
            currentPlaybackRate = parseFloat(speedSlider.value);
            if (audio) {
                audio.playbackRate = currentPlaybackRate;
            }
            speedModal.style.display = 'none';
        });

        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === helpModal) {
                helpModal.style.display = 'none';
            }
            if (e.target === aboutModal) {
                aboutModal.style.display = 'none';
            }
            if (e.target === speedModal) {
                speedModal.style.display = 'none';
            }
        });

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initLanguage();
        });

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            releaseWakeLock();
            if (audio) {
                audio.pause();
                audio.src = '';
            }
        });

        // Function to show a toast notification
        function showToast(message) {
            // Remove any existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = 'toast';
            if (currentLanguage === 'ar') {
                toast.classList.add('rtl');
            }
            toast.textContent = message;
            document.body.appendChild(toast);

            // Trigger the fade-in animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 10); // Small delay to ensure the class is added after the element is in the DOM

            // Remove the toast after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                // Wait for the fade-out transition to finish before removing the element
                setTimeout(() => {
                    toast.remove();
                }, 500);
            }, 3000);
        }
    </script>
</body>

</html>